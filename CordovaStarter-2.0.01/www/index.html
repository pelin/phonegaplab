<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>

    <title>Servicekoll 2</title>
        <script type="text/javascript" charset="utf-8" src="cordova-2.0.0-ios.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
	    <script type="text/javascript" src="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.js"></script>
        <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.0.15.min.js"></script>
        <script type="text/javascript" charset="utf-8" src="user.js"></script>

        <link rel="stylesheet" href="css/reset.css">
        <link rel="stylesheet" href="css/styles.css">
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.css" />


        <script type="text/javascript"  charset="utf-8">

            Parse.initialize("Ea6u4xJI1MOXQPHAnjHA4m4ivTLr8AE0hAwOTHzA", "pwZMfWDpRwn9G8TJf6kIlEuweYywx8zZqp641Ebj");

            var photodata = null;
            var lastSavedPhotoId = "";
            var currentWorkday = "";
            var currentPosition = null;

            function saveTaskPhoto(){


                $.mobile.showPageLoadingMsg("Bild", "Sparar bild...");       

                var TaskPhoto = Parse.Object.extend("TaskPhoto");

                var taskPhoto = new TaskPhoto();

                var img = document.getElementById('camera_image');
                var binaryphoto = getBase64Image(img);

                alert(binaryphoto);

                taskPhoto.set("taskid", 1337);
                taskPhoto.set("photo", binaryphoto);

                taskPhoto.save(null, {
                    success: function (taskPhoto) {
                        alert("success");
                        $(".success").show();

                        taskPhoto.fetch({
                            success: function (myObject) {
                                alert(myObject.id);
                                lastSavedPhotoId = myObject.id;
                            },
                            error: function (myObject, error) {
                                alert(error);
                            }
                        });



                    },
                    error: function (taskPhoto, error) {
                        $(".error").show();
                    }
                });

                
            };

            function getTaskPhoto() {

                var TaskPhoto = Parse.Object.extend("TaskPhoto");
                var query = new Parse.Query(TaskPhoto);
                query.get(lastSavedPhotoId, {
                    success: function (taskPhoto) {
                        alert("Success loading photo");

                        var img = document.getElementById('camera_image_loaded');
                        img.style.visibility = "visible";
                        img.style.display = "block";
                        var data = taskPhoto.get("photo");
                        img.src = "data:image/jpeg;base64," + data;
                        
                    },
                    error: function (taskPhoto, error) {
                        alert("Error loading");
                    }
                });

                
                
                
            };


            function startWorkday() {

                if (isUserLoggedIn()) {

                    onDispayCoordinates();

                    var user = Parse.User.current();

                    var Workday = Parse.Object.extend("Workday");
                    var workday = new Workday();

                    var now = new Date();
                    var nowstring = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds();

                    workday.set("start", nowstring);
                    workday.set("end", null);
                    workday.set("user", user);
                    placeObject.set("location", currentPosition);

                    workday.save(null, {
                        success: function (object) {
                            alert("Arbetsdagen börjar");

                            workday.fetch({
                                success: function (myObject) {
                                    currentWorkday = myObject;
                                    workdayStarted = currentWorkday.createdAt;
                                    $("#btnStartWorkday").hide();
                                    $("#btnEndWorkday").show();
                                },
                                error: function (myObject, error) {
                                    alert(error);
                                }
                            });

                        },
                        error: function (model, error) {
                            alert("Det uppstod ett fel");
                        }
                    });

                }
                else {
                    alert("Du måste logga in först");
                    self.navigation = "#loginview";
                }
            };

            function endWorkday() {


                    var now = new Date();
                    var nowstring = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds();

                    currentWorkday.set("end", nowstring);

                    currentWorkday.save(null, {
                        success: function (object) {
                            alert("Arbetsdagen slutar");
                            $("#btnStartWorkday").show();
                            $("#btnEndWorkday").hide();
                        },
                        error: function (model, error) {
                            alert("Det uppstod ett fel");
                        }
                    });

               
            };

            //------------------------------------------------------


            var deviceReady = false;

            function getBase64Image(img) {
                // Create an empty canvas element
                var canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;

                // Copy the image contents to the canvas
                var ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);

                // Get the data-URL formatted image
                // Firefox supports PNG and JPEG. You could check img.src to guess the
                // original format, but be aware the using "image/jpg" will re-encode the image.
                var dataURL = canvas.toDataURL("image/png");

                return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
            }


            //-------------------------------------------------------------------------
            // Camera
            //-------------------------------------------------------------------------

            /**
            * Capture picture
            */
            function getPicture() {

                //navigator.camera.getPicture(onPhotoDataSuccess, onFail, { quality: 50,
                //    destinationType: Camera.DestinationType.FILE_URI, sourceType : Camera.PictureSourceType.CAMERA });

                navigator.camera.getPicture(
                function (data) {
                    var img = document.getElementById('camera_image');
                    img.style.visibility = "visible";
                    img.style.display = "block";
                    img.src = "data:image/jpeg;base64," + data;

                    photodata = data;
                    $("btnSaveTaskPhoto").show();

                    //img.src = data;
                    document.getElementById('camera_status').innerHTML = "Success";
                },
                function (e) {
                    console.log("Error getting picture: " + e);
                    document.getElementById('camera_status').innerHTML = "Error getting picture.";
                },
                { quality: 50, destinationType: navigator.camera.DestinationType.DATA_URL, sourceType: navigator.camera.PictureSourceType.CAMERA });
            };

            /**
            * Select image from library
            */
            function getImage() {
                navigator.camera.getPicture(
                    function (data) {
                        var img = document.getElementById('camera_image');
                        img.style.visibility = "visible";
                        img.style.display = "block";
                        //img.src = "data:image/jpeg;base64," + data;
                        img.src = data;

                        photodata = data;
                        $("btnSaveTaskPhoto").show();

                        document.getElementById('camera_status').innerHTML = "Success";
                    },
                    function (e) {
                        console.log("Error getting picture: " + e);
                        document.getElementById('camera_status').innerHTML = "Error getting picture.";
                    },
                    { quality: 50, destinationType: navigator.camera.DestinationType.FILE_URI, sourceType: navigator.camera.PictureSourceType.PHOTOLIBRARY });
            };


            /**
            * Function called when page has finished loading.
            */
            function init() {
                document.addEventListener("deviceready", function () {
                    deviceReady = true;
                    alert("Ramverk laddat. Enhet=" + device.platform + " " + device.version);
                    console.log("Device=" + device.platform + " " + device.version);

                    initUser();


                }, false);
                window.setTimeout(function () {
                    if (!deviceReady) {
                        alert("Fel: Appen kan inte startas.  Vänligen avsluta och försök igen.");
                    }
                }, 10000);
            };


            function onDispayCoordinates() {
                navigator.geolocation.getCurrentPosition(onSuccess, onError);
            }

            // onSuccess Geolocation
            //
            function onSuccess(position) {
                var element = document.getElementById('geolocation');
                element.innerHTML = 'Latitude: ' + position.coords.latitude + '<br />' +
                                'Longitude: ' + position.coords.longitude + '<br />' +
                                'Altitude: ' + position.coords.altitude + '<br />' +
                                'Accuracy: ' + position.coords.accuracy + '<br />' +
                                'Altitude Accuracy: ' + position.coords.altitudeAccuracy + '<br />' +
                                'Heading: ' + position.coords.heading + '<br />' +
                                'Speed: ' + position.coords.speed + '<br />' +
                                'Timestamp: ' + position.timestamp + '<br />';
            }

            // onError Callback receives a PositionError object
            //
            function onError(error) {
                alert('code: ' + error.code + '\n' +
                  'message: ' + error.message + '\n');
            }




            ////////////////////////

            var x = document.getElementById("demo");
            function onDispayCoordinates() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(showPosition, showError);
                }
                else { x.innerHTML = "Geolocation is not supported by this browser."; }
            }

            function showPosition(position) {

                currentPosition = new Parse.GeoPoint({ latitude: position.coords.latitude, longitude: position.coords.longitude });


                var latlon = position.coords.latitude + "," + position.coords.longitude;

                var img_url = "http://maps.googleapis.com/maps/api/staticmap?center="
      + latlon + "&zoom=14&size=400x300&sensor=false";
                document.getElementById("mapholder").innerHTML = "<img src='" + img_url + "' />";

                document.getElementById("koord").innerHTML = "<span>" + latlon + "</span>";

            }

            function showError(error) {
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        x.innerHTML = "User denied the request for Geolocation."
                        break;
                    case error.POSITION_UNAVAILABLE:
                        x.innerHTML = "Location information is unavailable."
                        break;
                    case error.TIMEOUT:
                        x.innerHTML = "The request to get user location timed out."
                        break;
                    case error.UNKNOWN_ERROR:
                        x.innerHTML = "An unknown error occurred."
                        break;
                }
            }

            /////////////////////////


    </script>




  </head>
    <body onload="init();" >

        <!-- Start of first page -->
        <div data-role="page" id="home">

            <div data-role="header"  data-position="fixed">
                <h3>Servicekoll 0.2 </h3>
            </div><!-- /header -->

            <div data-role="content">	

                
                <div id="main">
                    <div style="display:none" class="error">
                      Fel!
                    </div>
                    <div style="display:none" class="success">
                      <p>Sparad!</p>
                    </div>
                </div>

                <button id="btnStartWorkday" onclick="startWorkday();">Starta dagen</button> <br/>
                <span id="workdayStarted"></span> <br/>
                <button id="btnEndWorkday" style="display:none;" onclick="endWorkday();">Avsluta dagen</button> <br/>

                <h1>Camera</h1>
                <div id="info">
                    Status: <span id="camera_status"></span><br/>
                    <img style="width:120px;height:120px;visibility:hidden;display:none;" id="camera_image" src="" />

                    <img style="width:120px;height:120px;visibility:hidden;display:none;" id="camera_image_loaded" src="" />

                </div>
                <h2>Action</h2>
                <a href="#" class="btn large" onclick="getPicture();">Take Picture</a>
                <a href="#" class="btn large" onclick="getImage();">Select Image from Library</a>
                <br/>
                <p>
               	    <a href="#" class="btn large" id="btnSaveTaskPhoto" onclick="saveTaskPhoto();" >Spara bilden med Parse</a> <br/>
                </p>

                <p>
               	    <a href="#" class="btn large" id="btnGetTaskPhoto" onclick="getTaskPhoto();" >Hämta bilden med Parse</a> <br/>
                </p>


                <p>Länk till andra sidan <a href="#bar">bar</a></p>
                

            </div><!-- /content -->


            <div data-role="footer" data-position="fixed" >
		        <h4>Page Footer</h4>
	        </div><!-- /footer -->

        </div><!-- /page -->



        <!-- Start of second page -->
        <div data-role="page" id="bar">

	        <div data-role="header"  data-position="fixed">
		        <h2>Bar</h2>
	        </div><!-- /header -->

	        <div data-role="content">	
             
                <h1>Position</h1>
                <p id="demo">Klicka här:</p>
                <button onclick="onDispayCoordinates();">Visa position</button> <br/>
    
                <div id="koord"></div>
                <div id="mapholder"></div>

		        <p><a href="#home">Tillbaka</a></p>	
	        </div><!-- /content -->

	        <div data-role="footer">
		        <h4>Page Footer</h4>
	        </div><!-- /footer -->
        </div><!-- /page -->

        <!-- Start of create user page -->
        <div data-role="page" id="loginview">

	        <div data-role="header"  data-position="fixed">
		        <h2>Skapa användare</h2>
	        </div><!-- /header -->

	        <div data-role="content">	
               
                <div data-role="fieldcontain" class="ui-hide-label">
	                <label for="username">Användarnamn:</label>
	                <input type="text" name="username" id="txtUsername" value="" placeholder="Användarnamn"/>
                </div>
                <div data-role="fieldcontain">
	                <label for="password">Password:</label>
	                <input type="password" name="password" id="txtPassword" value="" placeholder="Lösenord"/>
			    </div>

                
                <a href="#" class="btn large"  id="btnLoginUser" style="display:none;" onclick="loginUser();">Logga in</a>
                <button  id="btnCreateUser" onclick="createUser();">Skapa ny användare</button>
                <a href="#" class="btn large"  id="btnLogout" style="display:none;">Logga ut</a>

		        <p><a href="#home">Tillbaka</a></p>	
	        </div><!-- /content -->

	        <div data-role="footer"  data-position="fixed">
		        <h4>Page Footer</h4>
	        </div><!-- /footer -->
        </div><!-- /page -->



    


  </body>
</html>
